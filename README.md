# KIT-PVMDS: Proxmox VM Deployment Script

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**KIT-PVMDS** (Kudesnik-IT Proxmox VM Deployment Script) — это инструмент для автоматизации создания и настройки виртуальных машин в **Proxmox VE**. Скрипт позволяет быстро развернуть готовую к работе виртуальную машину с предустановленным **Debian 12 (genericcloud)**, **Docker** и **Docker Compose**, а также настроить SSH-ключи, пользователей и сетевые параметры.

---

## Оглавление

1. [Что делает этот скрипт?](#что-делает-этот-скрипт)
2. [Требования](#требования)
3. [Установка и использование](#установка-и-использование)
4. [Общее описание](#общее-описание)
   - [Принципы формирования ID и имен виртуальных машин](#принципы-формирования-id-и-имен-виртуальных-машин)
   - [Сетевые настройки](#сетевые-настройки)
   - [Доступы и авторизация](#доступы-и-авторизация)
   - [Работа с образами](#работа-с-образами)
5. [Переменные и параметры](#переменные-и-параметры)
   - [Переменные](#переменные)
   - [Аргументы командной строки](#аргументы-командной-строки)
6. [Примеры запуска скрипта](#примеры-запуска-скрипта)
7. [Лицензия](#лицензия)
8. [Автор](#автор)
9. [Отзывы и предложения](#отзывы-и-предложения)

---

## Что делает этот скрипт?

Скрипт выполняет следующие задачи:

1. **Скачивание образа Debian**:  
   - Используется официальный образ **Debian 12 (genericcloud)** в формате `raw`, оптимизированный для облачных решений.
   - Образ после скачивания проверяется на целостность с помощью контрольной суммы SHA512.

2. **Настройка cloud-init**:  
   - Создается конфигурационный файл cloud-init для автоматической настройки системы при первом запуске.
   - Настройка включает создание пользователя, настройку сети, установку Docker и Docker Compose.

3. **Генерация SSH-ключей**:  
   - Для безопасного доступа к виртуальной машине создаются уникальные SSH-ключи.
   - Публичный ключ через конфигурацию cloud-init переносится на виртуальную машину.

4. **Настройка сети**:  
   - Поддерживается как DHCP, так и статическая IP-адресация.
   - Можно генерировать уникальные IP-адреса для каждой виртуальной машины на основе её ID.

5. **Создание и настройка виртуальной машины**:  
   - Виртуальная машина создается со следующими параметрами производительности: тип `q35`, 4 ядра, 8 ГБ RAM.
   - Диски подключаются через интерфейс SCSI для максимальной производительности.

6. **Установка Docker и Docker Compose**:  
   - Внутри виртуальной машины автоматически устанавливаются Docker и Docker Compose.

7. **Прочее**:  
   - После создания виртуальной машины можно удалить скачанный образ Debian для экономии места.

---

## Требования

Для работы скрипта необходимы следующие компоненты:

- **Proxmox VE 8.2+**
- **Bash 5.2+**
- **Coreutils** (для команд `echo`, `curl` и т.д.)
- **SSH-клиент**

---

## Установка и использование

### 1. Сделайте скрипт исполняемым:
```bash
chmod +x proxmox_create_vm.sh
```

### 2. Запустите скрипт:
```bash
./proxmox_create_vm.sh [options]
```

### 3. Следуйте инструкциям на экране:
Скрипт предоставляет подсказки и справку по использованию. Для просмотра справки используйте:
```bash
./proxmox_create_vm.sh --help
```

---

## Общее описание

### Принципы формирования ID и имен виртуальных машин

ID виртуальной машины состоит из двух частей:
- **Постоянная часть (`VM_ID`)**: Задается в скрипте (например, `123`).
- **Изменяемая часть**: Число, которое передается первым аргументом при запуске (например, `001`).

Итоговый ID будет объединением этих частей (например, `123001`). 

Имя виртуальной машины формируется аналогично, из **постоянной части (`VM_NAME`)** и числом переданным первым аргументом (например, `Debian-Srv001`).

#### Пример:
Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
```
Если запустить скрипт три раза:
```bash
./create_vm.sh 001
./create_vm.sh 002
./create_vm.sh 003
```
будут созданы три виртуальные машины:
- `123001` (`Debian-Srv123001`)
- `123002` (`Debian-Srv123002`)
- `123003` (`Debian-Srv123003`)

---

### Сетевые настройки

Для настройки сети используются переменные `VM_IP`, `VM_GATEWAY` и `VM_BRIDGE`.

- Если параметр `VM_IP` пустой, используется DHCP.
- Для статической адресации в параметре `VM_IP` нужно указать IP-адрес и маску в формате CIDR, например: `10.0.0.1/24`.
- IP-адрес шлюза задается в параметре `VM_GATEWAY` и используется только для статической адресации.

Скрипт присоединяет сетевую карточку виртуальной машины к одному из бриджей в Proxmox, указанному в переменной `VM_BRIDGE`. Это позволяет организовать корректное взаимодействие виртуальной машины с сетью через выбранный мост (bridge).

| **Параметр** | **`SET_IP_FROM_ID`** |
|--------------|----------------------|

Параметр `SET_IP_FROM_ID` определяет, будет ли скрипт автоматически генерировать уникальный IP-адрес для каждой виртуальной машины на основе её ID. Если эта переменная установлена в значение `true`, то к четвертому октету базового IP-адреса (указанного в переменной `VM_IP`) будет добавлено числовое значение изменяемой части ID виртуальной машины.

**Принцип работы**:
1. Базовый IP-адрес задается в формате CIDR, например: `192.168.1.10/24`.
2. При запуске скрипта изменяемая часть ID (переданная первым параметром) добавляется к четвертому октету базового IP-адреса.
3. Если результат превышает `255` (максимальное значение для октета), то он автоматически ограничивается значением `255`.

**Пример**:
Предположим, что:
- Базовый IP-адрес: `192.168.1.10/24`
- Изменяемые части ID: `001`, `002`, `003`

Если `SET_IP_FROM_ID=true`, то будут созданы следующие IP-адреса:
- Для ID `001`: `192.168.1.11/24`
- Для ID `002`: `192.168.1.12/24`
- Для ID `003`: `192.168.1.13/24`

**Значение по умолчанию**:  
`false` (генерация уникальных IP-адресов отключена).

**Когда использовать**:  
Эта функция полезна, если вы хотите автоматически назначать уникальные статические IP-адреса для каждой виртуальной машины без ручной настройки. Она особенно удобна при массовом развертывании виртуальных машин с предсказуемыми сетевыми настройками.


⚙️ **Настройка очередей для сетевой карты**

Для увеличения производительности обработки сетевого трафика в Proxmox рекомендуется добавлять очереди (queues) к сетевой карте виртуальной машины. Очереди позволяют распределить нагрузку между несколькими ядрами процессора хоста, что значительно повышает пропускную способность и снижает задержки.

- Количество очередей должно быть равно или меньше числа ядер, выделенных для виртуальной машины. Например, если виртуальной машине выделено 4 ядра, можно настроить до 4 очередей.
- В скрипте параметр `queues` задается равным значению `4`, равным количеству выделенных виртуальной машине ядер.


🖥️ **Аргументы командной строки, связанные с сетью**

При запуске скрипта можно указать дополнительные аргументы для настройки сети:

1. **`-i, --ip`**:
   - Указывает IP-адрес и маску для статической адресации.
   - Пример: `-i 192.168.1.10/24`.

2. **`-g, --gateway`**:
   - Указывает IP-адрес шлюза для статической адресации.
   - Пример: `-g 192.168.1.1`.

3. **`--bridge`**:
   - Указывает имя моста (bridge), к которому будет подключена сетевая карта виртуальной машины.
   - Пример: `--bridge vmbr0`.


⚠️ **Важные замечания**

1. **DHCP vs. Статическая адресация**:
   - Если параметр `VM_IP` не указан, виртуальная машина будет использовать DHCP для получения IP-адреса.
   - Для статической адресации обязательно нужно указать как `VM_IP`, так и `VM_GATEWAY`.

2. **Производительность сети**:
   - Использование `virtio` для сетевой карты и настройка очередей (`queues`) значительно повышают производительность сети.
   - Количество очередей должно соответствоватьт количеству ядер, выделенных для виртуальной машины. При изменении количества ядер необходимо изменить количество очередей в сетевой карте.

3. **Мосты (bridges)**:
   - Мосты в Proxmox (например, `vmbr0`, `vmbr1`) должны быть предварительно настроены в интерфейсе Proxmox или через CLI.
   - Выбор моста зависит от вашей сетевой архитектуры (например, vmbr0).

---

### Доступы и авторизация

В этом разделе описываются все параметры, связанные с созданием пользователя, настройкой SSH-ключей и паролей для виртуальной машины. Эти настройки обеспечивают безопасный доступ к виртуальной машине после её создания.

👤 **Создание пользователя**
Пользователь создается автоматически через cloud-init при первом запуске виртуальной машины. Имя пользователя задается переменной `CI_USER` или аргументом `-u/--username` при запуске скрипта.

- Переменная `CI_USER`: Значение по умолчанию: `virtman`.
  ```bash
  ./create_vm.sh 001
  ```
  В результате будет создан пользователь `virtman` с правами `sudo`.
- Имя пользователя можно передать через аргумент `-u`:
  ```bash
  ./create_vm.sh 001 -u myuser
  ```
  В результате будет создан пользователь `myuser` с правами `sudo`.

🔑 **SSH-ключи**
SSH-ключи используются для безопасного подключения к виртуальной машине без необходимости ввода пароля. Скрипт автоматически генерирует SSH-ключи для каждой виртуальной машины.

- **Что такое SSH-ключи?**
  - SSH-ключи — это пара файлов (приватный и публичный ключ), которые используются для аутентификации вместо пароля.
  - Приватный ключ хранится на вашем компьютере и используется для подключения.
  - Публичный ключ добавляется в конфигурацию виртуальной машины и позволяет серверу проверить вашу личность.

- **Где хранятся ключи?**
  - Ключи сохраняются в директории, указанной в переменной `KEYS_PATH` (по умолчанию `/root/.keys/`).
  - Имена ключей формируются на основе префикса (`KEY_NAME`) и ID виртуальной машины. Например:
    - Приватный ключ: `/root/.keys/vm-123001`
    - Публичный ключ: `/root/.keys/vm-123001.pub`

- **Как получить доступ с использованием ключей?**
  Для подключения к виртуальной машине используйте команду:
  ```bash
  ssh -i /path/to/private/key <username>@<IP-address>
  ```
  Пример:
  ```bash
  ssh -i /root/.keys/vm-123001 virtman@10.0.0.1
  ```

- **Настройка ключей в cloud-init**:
  Публичный ключ автоматически добавляется в конфигурацию cloud-init, чтобы обеспечить доступ к виртуальной машине сразу после её создания.

🔒 **Парольная аутентификация**
Если вы хотите разрешить вход с использованием пароля, это можно настроить через переменную `SET_USER_PASS` или аргумент `-a/--auth`.

- **Переменная `SET_USER_PASS`**:
  - Значение по умолчанию: `false` (парольная аутентификация отключена).
  - Если установлено значение `true`, для пользователя будет создан пароль.

- **Хэш пароля**:
  Пароль не хранится в открытом виде, а преобразуется в хэш с помощью функции шифрования. Это повышает безопасность, при компроментации хэш-пароля затруднительно получить пароль.

  - **Как создать хэш пароля?**
    Используйте команду `openssl` для генерации хэша:
    ```bash
    openssl passwd -6
    ```
    Пример вывода:
    ```
    $6$randomsalt$hashedpassword
    ```
    Этот хэш можно передать через переменную `CI_PASS` или аргумент `-p/--password`:
    ```bash
    ./create_vm.sh 001 -p '$6$randomsalt$hashedpassword'
    ```
  - **Переменная `CI_PASS`**:
    - По умолчанию хэш не указан. Если хэш пароля не указан и не передан через аргумент, то скрипт, в процессе выполнения, запросит пароль в командной строке и создаст новый хэш-пароль.
    - При записи кэша в переменную его необходимо заключать в апострофы ` ' ` (не в кавычки)
      Например:
      ```
      CI_PASS='$6$randomsalt$hashedpassword'
      ``` 

🖥️ **Аргументы командной строки**

При запуске скрипта можно использовать следующие аргументы для настройки доступа:

- **`-u, --username`**:
  - Указывает имя пользователя, который будет создан в виртуальной машине.
  - Пример:
    ```bash
    ./create_vm.sh 001 -u adminuser
    ```

- **`-p, --password`**:
  - Указывает хэш пароля для пользователя.
  - Пример:
    ```bash
    ./create_vm.sh 001 -p '$6$randomsalt$hashedpassword'
    ```

- **`-a, --auth`**:
  - Разрешает парольную аутентификацию для пользователя.
  - Пример:
    ```bash
    ./create_vm.sh 001 -a
    ```

🔒 **Безопасность**

- **Отключение root-доступа**:
  В конфигурации cloud-init автоматически отключается доступ для пользователя `root`:
  ```yaml
  disable_root: true
  ```
  Это усложняет несанкционированный доступ к системе.

- **Отключение парольной аутентификации**:
  По умолчанию парольная аутентификация отключена:
  ```yaml
  ssh_pwauth: false
  ```
  Это увеличивает безопасность, ограничивая доступ только через SSH-ключи.

🖥️ **Пример полной команды**

Создание виртуальной машины с пользователем `adminuser`, хэшем пароля и разрешением парольной аутентификации:
```bash
./create_vm.sh 001 -u adminuser -p '$6$randomsalt$hashedpassword' -a
```

---

### Работа с образами

- Образ Debian загружается с официального репозитория:
  ```
  https://cdimage.debian.org/images/cloud/bookworm/latest/
  ```
- Для проверки целостности образа используется файл контрольных сумм, ссылка на который указывается в переменной `URL_RAW_SHA`.
- Образ сохраняется в хранилище ISO (по умолчанию `/var/lib/vz/template/iso/`), и его можно настроить через переменные:
  - `FILE_RAW`: Имя файла образа.
  - `ISO_PATH`: Путь к хранилищу ISO.
- После создания виртуальной машины образ может быть удален (если включена опция `DEL_FILE_RAW=true`).

---

## Переменные и параметры

### Переменные

| Переменная          | Описание                                                                 |
|---------------------|-------------------------------------------------------------------------|
| `VM_ID`             | Постоянная часть ID виртуальной машины.                                 |
| `VM_NAME`           | Основа имени виртуальной машины.                                        |
| `VM_IP`             | IP-адрес и маска для статической настройки сети.                        |
| `VM_GATEWAY`        | Шлюз по умолчанию.                                                      |
| `VM_BRIDGE`         | Мост (bridge) к которому будет подключаться сетевая карта виртуалньой машины  |
| `CI_USER`           | Имя пользователя для доступа к виртуальной машине.                      |
| `CI_PASS`           | Хэш пароля для пользователя (если используется).                        |
| `STORAGE_SNIP`      | Хранилище для snippets (обычно то же, что и для ISO-образов).           |
| `STORAGE_DISK`      | Хранилище для дисков виртуальной машины.                                |
| `SNIP_PATH`         | Директория для хранения файлов cloud-init.                              |
| `ISO_PATH`          | Директория для хранения ISO-образов.                                    |
| `FILE_RAW`          | Имя файла образа Debian.                                                |
| `VM_DISK_SIZE`      | Размер диска с корневой системой                                        |
| `URL_RAW`           | URL для скачивания образа Debian.                                       |
| `URL_RAW_SHA`       | URL для скачивания файла контрольных сумм.                              |
| `KEYS_PATH`         | Директория для хранения SSH-ключей.                                     |
| `KEY_NAME`          | Префикс для имен SSH-ключей.                                            |
| `SET_KEY_PASS`      | Установка секретной фразы для SSH-ключей.                               |
| `SET_USER_PASS`     | Разрешение парольной аутентификации для пользователя.                   |
| `RUN_VM`            | Запуск виртуальной машины после создания. Принимает три значения: true (всегда запускать), false (никогда не запускать), ask (всегда спрашивать)   |
| `SET_FILE_RAW_IMG`  | Добавление расширения `.img` к файлу образа для отображения в веб-интерфейсе. |
| `DEL_FILE_RAW`      | Удаление файла образа после создания виртуальной машины.                |
| `SET_IP_FROM_ID`    | Генерация уникального IP-адреса на основе ID.                           |
| `SET_DEL_CLOUDINIT` | Удаление cloud-init после запуска и настройки системы                   |

### Аргументы командной строки

| Аргумент            | Описание                                                                |
|---------------------|-------------------------------------------------------------------------|
| Первый аргумент     | Изменяемая часть ID виртуальной машины (обязательный).                  |
| `-u, --username`    | Имя пользователя для доступа к виртуальной машине.                      |
| `-p, --password`    | Хэш пароля для пользователя (`openssl passwd -6`).                      |
| `-a, --auth`        | Включение парольной аутентификации.                                     |
| `-i, --ip`          | IP-адрес и маска для статической настройки сети.                        |
| `-g, --gateway`     | Шлюз по умолчанию.                                                      |
| `-f, --file`        | Путь к файлу образа Debian.                                             |
| `-h, --help`        | Показать справку по использованию скрипта.                              |

---

## Примеры запуска скрипта

### 1. Создание виртуальной машины с DHCP
Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
VM_IP=""
```
Команда:
```bash
./create_vm.sh 001
```

#### Результат:
- **ID**: `123001`
- **Имя**: `Debian-Srv001`
- **Сеть**: DHCP (автоматическая настройка IP-адреса)
- **Пользователь**: `virtman` (по умолчанию)
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123001` и `/root/.keys/vm-123001.pub`.
- **Docker**: Установлен и настроен.

---

### 2. Создание виртуальной машины с настройкой статического IP
Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
VM_IP="10.1.1.10/24"
VM_GATEWAY="10.1.1.254"
```
Команда:
```bash
./create_vm.sh 002
```

**ИЛИ**

Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
VM_IP=""
```
Команда:
```bash
./create_vm.sh 002 --ip 10.1.1.10/24 --gateway 10.1.1.254
```

#### Результат:
- **ID**: `123002`
- **Имя**: `Debian-Srv002`
- **Сеть**: Статический IP `10.1.1.10/24`, шлюз `10.1.1.254`.
- **Пользователь**: `virtman` (по умолчанию).
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123002` и `/root/.keys/vm-123002.pub`.

---

### 3. Создание виртуальной машины с указанием имени пользователя и пароля
Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
CI_USER="myuser"
CI_PASS='$6$randomsalt$hashedpassword'
```
Команда:
```bash
./create_vm.sh 003
```

**ИЛИ**

Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
CI_USER="virtman"
CI_PASS=''
```
Команда:
```bash
./create_vm.sh 003 --username myuser --password $6$randomsalt$hashedpassword
```

#### Результат:
- **ID**: `123003`
- **Имя**: `Debian-Srv003`
- **Сеть**: DHCP (автоматическая настройка IP-адреса).
- **Пользователь**: `myuser` (создан новый пользователь).
- **Пароль**: Настроен пароль для пользователя `myuser`.
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123003` и `/root/.keys/vm-123003.pub`.

---

### 4. Создание виртуальной машины с уникальными IP-адресами
Если включен параметр `SET_IP_FROM_ID=true`, то к четвертому октету базового IP-адреса добавляется значение изменяемой части ID.
Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
VM_IP="10.1.1.10/24"
VM_GATEWAY="10.1.1.254"
SET_IP_FROM_ID=true
```
Команда:
```bash
./create_vm.sh 001 
./create_vm.sh 002 
./create_vm.sh 003 
```

**ИЛИ**

Значения переменных:
```
VM_ID="123"
VM_NAME="Debian-Srv"
VM_IP=""
VM_GATEWAY=""
SET_IP_FROM_ID=true
```
Команда:
```bash
./create_vm.sh 001 --ip 10.1.1.1/24 --gateway 10.1.1.254
./create_vm.sh 002 --ip 10.1.1.1/24 --gateway 10.1.1.254
./create_vm.sh 003 --ip 10.1.1.1/24 --gateway 10.1.1.254
```

#### Результат:
- **VM 1**:
  - **ID**: `123001`
  - **Имя**: `Debian-Srv001`
  - **IP**: `10.1.1.11/24`
- **VM 2**:
  - **ID**: `123002`
  - **Имя**: `Debian-Srv002`
  - **IP**: `10.1.1.12/24`
- **VM 3**:
  - **ID**: `123003`
  - **Имя**: `Debian-Srv003`
  - **IP**: `10.1.1.13/24`

---

### 5. Создание виртуальной машины с использованием собственного образа
```bash
./create_vm.sh 004 --file /path/to/custom-image.raw
```

#### Результат:
- **ID**: `123004`
- **Имя**: `Debian-Srv004`
- **Образ**: Используется пользовательский образ `/path/to/custom-image.raw`.
- **Сеть**: DHCP (автоматическая настройка IP-адреса).
- **Пользователь**: `virtman` (по умолчанию).
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123004` и `/root/.keys/vm-123004.pub`.

---

## Лицензия

Этот проект распространяется под лицензией **MIT License**. Вы можете свободно использовать, модифицировать и распространять скрипт. Подробности см. в файле [LICENSE](LICENSE).

---

## Автор

- **Автор**: Kudesnik-IT  
- **GitHub**: [https://github.com/Kudesnik-IT/proxmox-create-vm](https://github.com/Kudesnik-IT/proxmox-create-vm)  
- **Дата создания**: 2025-06-02  
- **Последнее обновление**: 2025-06-02  

---

## Отзывы и предложения

Если у вас есть вопросы, предложения или вы нашли ошибку, пожалуйста, создайте issue в репозитории или свяжитесь с автором напрямую.

---

Спасибо за использование **KIT-PVMDS**! Надеюсь, что этот скрипт поможет быстро и эффективно разворачивать виртуальные машины в Proxmox VE.
