# KIT-PVMDS: Proxmox VM Deployment Script

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**KIT-PVMDS** (Kudesnik-IT Proxmox VM Deployment Script) — это инструмент для автоматизации создания и настройки виртуальных машин в **Proxmox VE**. Скрипт позволяет быстро развернуть готовую к работе виртуальную машину с предустановленным **Debian 12 (genericcloud)**, **Docker** и **Docker Compose**, а также настроить SSH-ключи, пользователей и сетевые параметры.

---

## Оглавление

1. [Что делает этот скрипт?](#что-делает-этот-скрипт)
2. [Требования](#требования)
3. [Установка и использование](#установка-и-использование)
4. [Общее описание](#общее-описание)
   - [Принципы формирования ID и имен виртуальных машин](#принципы-формирования-id-и-имен-виртуальных-машин)
   - [Сетевые настройки](#сетевые-настройки)
   - [Доступы и авторизация](#доступы-и-авторизация)
   - [Работа с образами](#работа-с-образами)
5. [Переменные и параметры](#переменные-и-параметры)
   - [Переменные](#переменные)
   - [Аргументы командной строки](#аргументы-командной-строки)
6. [Примеры запуска скрипта](#примеры-запуска-скрипта)
7. [Лицензия](#лицензия)
8. [Автор](#автор)
9. [Отзывы и предложения](#отзывы-и-предложения)

---

## Что делает этот скрипт?

Скрипт выполняет следующие задачи:

1. **Скачивание образа Debian**:  
   - Используется официальный образ **Debian 12 (genericcloud)** в формате `raw`, оптимизированный для облачных решений.
   - Образ после скачивания проверяется на целостность с помощью контрольной суммы SHA512.

2. **Настройка cloud-init**:  
   - Создается конфигурационный файл cloud-init для автоматической настройки системы при первом запуске.
   - Настройка включает создание пользователя, настройку сети, установку Docker и Docker Compose.

3. **Генерация SSH-ключей**:  
   - Для безопасного доступа к виртуальной машине создаются уникальные SSH-ключи.
   - Публичный ключ через конфигурацию cloud-init переносится на виртуальную машину.

4. **Настройка сети**:  
   - Поддерживается как DHCP, так и статическая IP-адресация.
   - Можно генерировать уникальные IP-адреса для каждой виртуальной машины на основе её ID.

5. **Создание и настройка виртуальной машины**:  
   - Виртуальная машина создается со следующими параметрами производительности: тип `q35`, 4 ядра, 8 ГБ RAM.
   - Диски подключаются через интерфейс SCSI для максимальной производительности.

6. **Установка Docker и Docker Compose**:  
   - Внутри виртуальной машины автоматически устанавливаются Docker и Docker Compose.

7. **Прочее**:  
   - После создания виртуальной машины можно удалить скачанный образ Debian для экономии места.

---

## Требования

Для работы скрипта необходимы следующие компоненты:

- **Proxmox VE 8.2+**
- **Bash 5.2+**
- **Coreutils** (для команд `echo`, `curl` и т.д.)
- **SSH-клиент**

---

## Установка и использование

### 1. Сделайте скрипт исполняемым:
```bash
chmod +x proxmox_create_vm.sh
```

### 2. Запустите скрипт:
```bash
./proxmox_create_vm.sh [options]
```

### 3. Следуйте инструкциям на экране:
Скрипт предоставляет подсказки и справку по использованию. Для просмотра справки используйте:
```bash
./proxmox_create_vm.sh --help
```

---

## Общее описание

### Принципы формирования ID и имен виртуальных машин

ID виртуальной машины состоит из двух частей:
- **Постоянная часть (`VM_ID`)**: Задается в скрипте (например, `123`).
- **Изменяемая часть**: Передается первым аргументом при запуске (например, `001`).

Итоговый ID будет объединением этих частей (например, `123001`). Имя виртуальной машины формируется аналогично (например, `Debian-Srv123001`).

#### Пример:
Если запустить скрипт три раза:
```bash
./create_vm.sh 001
./create_vm.sh 002
./create_vm.sh 003
```
будут созданы три виртуальные машины с ID: `123001`, `123002`, `123003` и именами: `Debian-Srv123001`, `Debian-Srv123002`, `Debian-Srv123003`.

---

### Сетевые настройки

Для настройки сети используются переменные `VM_IP`, `VM_GATEWAY` и `VM_BRIDGE`. Скрипт присоединяет сетевую карточку виртуальной машины к одному из бриджей в Proxmox, указанному в переменной `VM_BRIDGE`.

- Если параметр `VM_IP` пустой, используется DHCP.
- Для статической IP-адресации можно указать IP-адрес и шлюз через параметры `--ip` и `--gateway`.
- Если включен параметр `SET_IP_FROM_ID`, 4-й октет IP-адреса увеличивается на значение изменяемой части ID.

#### Пример:
Если задан базовый адрес `10.0.0.1/24` и запущен скрипт три раза:
```bash
./create_vm.sh 001
./create_vm.sh 002
./create_vm.sh 003
```
будут созданы три виртуальные машины с IP: `10.0.0.2/24`, `10.0.0.3/24`, `10.0.0.4/24`.

---

### Доступы и авторизация

В виртуальной машине создается новый пользователь с правами `sudo`. Имя пользователя задается через переменную `CI_USER` или аргумент `-u`. Для данного пользователя будет настроен удаленный доступ по SSH-ключам, которые сохраняются в директории, указанной в переменной `KEYS_PATH`.

Имена ключей состоят из префикса (`KEY_NAME`) и ID виртуальной машины (например, `vm-123001`).

---

### Работа с образами

- Образ Debian загружается с официального репозитория:
  ```
  https://cdimage.debian.org/images/cloud/bookworm/latest/
  ```
- Для проверки целостности образа используется файл контрольных сумм, ссылка на который указывается в переменной `URL_RAW_SHA`.
- Образ сохраняется в хранилище ISO (по умолчанию `/var/lib/vz/template/iso/`), и его можно настроить через переменные:
  - `FILE_RAW`: Имя файла образа.
  - `ISO_PATH`: Путь к хранилищу ISO.
- После создания виртуальной машины образ может быть удален (если включена опция `DEL_FILE_RAW=true`).

---

## Переменные и параметры

### Переменные

| Переменная          | Описание                                                                 |
|---------------------|-------------------------------------------------------------------------|
| `VM_ID`             | Постоянная часть ID виртуальной машины.                                 |
| `VM_NAME`           | Основа имени виртуальной машины.                                        |
| `VM_IP`             | IP-адрес и маска для статической настройки сети.                        |
| `VM_GATEWAY`        | Шлюз по умолчанию.                                                      |
| `CI_USER`           | Имя пользователя для доступа к виртуальной машине.                      |
| `CI_PASS`           | Хэш пароля для пользователя (если используется).                        |
| `STORAGE_SNIP`      | Хранилище для snippets (обычно то же, что и для ISO-образов).           |
| `STORAGE_DISK`      | Хранилище для дисков виртуальной машины.                                |
| `SNIP_PATH`         | Директория для хранения файлов cloud-init.                              |
| `ISO_PATH`          | Директория для хранения ISO-образов.                                    |
| `FILE_RAW`          | Имя файла образа Debian.                                                |
| `URL_RAW`           | URL для скачивания образа Debian.                                       |
| `URL_RAW_SHA`       | URL для скачивания файла контрольных сумм.                              |
| `KEYS_PATH`         | Директория для хранения SSH-ключей.                                     |
| `KEY_NAME`          | Префикс для имен SSH-ключей.                                            |
| `SET_KEY_PASS`      | Установка секретной фразы для SSH-ключей.                               |
| `SET_USER_PASS`     | Разрешение парольной аутентификации для пользователя.                   |
| `RUN_VM`            | Запуск виртуальной машины после создания.                               |
| `SET_FILE_RAW_IMG`  | Добавление расширения `.img` к файлу образа для отображения в веб-интерфейсе. |
| `DEL_FILE_RAW`      | Удаление файла образа после создания виртуальной машины.                |
| `SET_IP_FROM_ID`    | Генерация уникального IP-адреса на основе ID.                           |

### Аргументы командной строки

| Аргумент            | Описание                                                                |
|---------------------|-------------------------------------------------------------------------|
| Первый аргумент     | Изменяемая часть ID виртуальной машины (обязательный).                  |
| `-u, --username`    | Имя пользователя для доступа к виртуальной машине.                      |
| `-p, --password`    | Хэш пароля для пользователя (`openssl passwd -6`).                      |
| `-a, --auth`        | Включение парольной аутентификации.                                     |
| `-i, --ip`          | IP-адрес и маска для статической настройки сети.                        |
| `-g, --gateway`     | Шлюз по умолчанию.                                                      |
| `-f, --file`        | Путь к файлу образа Debian.                                             |
| `-h, --help`        | Показать справку по использованию скрипта.                              |

---

## Примеры запуска скрипта

### 1. Создание виртуальной машины с DHCP
```bash
./create_vm.sh 001
```

#### Результат:
- **ID**: `123001`
- **Имя**: `Debian-Srv123001`
- **Сеть**: DHCP (автоматическая настройка IP-адреса)
- **Пользователь**: `virtman` (по умолчанию)
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123001` и `/root/.keys/vm-123001.pub`.
- **Docker**: Установлен и настроен.

---

### 2. Создание виртуальной машины с настройкой статического IP
```bash
./create_vm.sh 002 --ip 192.168.1.10/24 --gateway 192.168.1.1
```

#### Результат:
- **ID**: `123002`
- **Имя**: `Debian-Srv123002`
- **Сеть**: Статический IP `192.168.1.10/24`, шлюз `192.168.1.1`.
- **Пользователь**: `virtman` (по умолчанию).
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123002` и `/root/.keys/vm-123002.pub`.

---

### 3. Создание виртуальной машины с указанием имени пользователя и пароля
```bash
./create_vm.sh 003 --username myuser --password mypassword
```

#### Результат:
- **ID**: `123003`
- **Имя**: `Debian-Srv123003`
- **Сеть**: DHCP (автоматическая настройка IP-адреса).
- **Пользователь**: `myuser` (создан новый пользователь).
- **Пароль**: Настроен пароль для пользователя `myuser`.
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123003` и `/root/.keys/vm-123003.pub`.

---

### 4. Создание виртуальной машины с уникальными IP-адресами
Если включен параметр `SET_IP_FROM_ID=true`, то к четвертому октету базового IP-адреса добавляется значение изменяемой части ID.

#### Команда:
```bash
./create_vm.sh 001 --ip 10.0.0.1/24 --gateway 10.0.0.1
./create_vm.sh 002 --ip 10.0.0.1/24 --gateway 10.0.0.1
./create_vm.sh 003 --ip 10.0.0.1/24 --gateway 10.0.0.1
```

#### Результат:
- **VM 1**:
  - **ID**: `123001`
  - **Имя**: `Debian-Srv123001`
  - **IP**: `10.0.0.2/24`
- **VM 2**:
  - **ID**: `123002`
  - **Имя**: `Debian-Srv123002`
  - **IP**: `10.0.0.3/24`
- **VM 3**:
  - **ID**: `123003`
  - **Имя**: `Debian-Srv123003`
  - **IP**: `10.0.0.4/24`

---

### 5. Создание виртуальной машины с использованием собственного образа
```bash
./create_vm.sh 004 --file /path/to/custom-image.raw
```

#### Результат:
- **ID**: `123004`
- **Имя**: `Debian-Srv123004`
- **Образ**: Используется пользовательский образ `/path/to/custom-image.raw`.
- **Сеть**: DHCP (автоматическая настройка IP-адреса).
- **Пользователь**: `virtman` (по умолчанию).
- **SSH-ключи**: Созданы автоматически, расположены в `/root/.keys/vm-123004` и `/root/.keys/vm-123004.pub`.

---

## Лицензия

Этот проект распространяется под лицензией **MIT License**. Вы можете свободно использовать, модифицировать и распространять скрипт. Подробности см. в файле [LICENSE](LICENSE).

---

## Автор

- **Автор**: Kudesnik-IT  
- **GitHub**: [https://github.com/Kudesnik-IT/proxmox-create-vm](https://github.com/Kudesnik-IT/proxmox-create-vm)  
- **Дата создания**: 2025-06-02  
- **Последнее обновление**: 2025-06-02  

---

## Отзывы и предложения

Если у вас есть вопросы, предложения или вы нашли ошибку, пожалуйста, создайте issue в репозитории или свяжитесь с автором напрямую.

---

Спасибо за использование **KIT-PVMDS**! Надеюсь, что этот скрипт поможет быстро и эффективно разворачивать виртуальные машины в Proxmox VE. 🚀
